<html>
<head>
	<meta charset="utf-8" />
	<script>
	/*
	One item per line. Item format:

	key:placeholder:group

	- key is the key name in the final dict
	- placeholder is the value displayed in the placeholder
	- group is "?" if the item is optional
	- group is a group name is the group is optional
	
	optional items are not listed if the value is empty
	optional groups are not listed if no item in it has a value
	*/
	let fields_generator = `
	ssid:home
	password:password01
	timezone:Europe/Paris:?
	aio_username:Username:aio
	aio_key:bfa67934:aio
	openweather_token:c1332f68:ow
	openweather_location:Paris, FR:ow
	`;
	</script>
	<title>Create config</title>
	<style>
	#the_form p {
		display: table-row;
	}
	#the_form p label {
		text-align: right;
	}
	#the_form p label,
	#the_form p input {
		display: table-cell;
		padding: 2px 4px;
	}
	#the_form p input {
		font-size: inherit;
		background-color: rgba(255,255,255,0.8);
	}
	.hidden {
		display: none;
	}
	#generate_config {
		display: table-row;
	}
	#generate_config it {
		display: table-cell;
		text-align: right;
	}
	#generate_config it button {
		font-size: inherit;
		padding: 8px;
		margin-top: 4px;
	}
	#download {
		display: none;
		margin: 20px 0px;
	}
	#output_text {
		display: none;
	}
	#download_link {
		text-decoration: none;
		color: black;
		background: white;
		padding: 8px;
		border-radius: 16px;
		border: 2px solid #888;
	}
	#download_link:hover {
		background: black;
		color: white;
	}
	star {
		color: red;
	}
	</style>
	<script>
	STAR = '<star>*</star>';
	colors = ["#97FFF9", "#FFFC79", "#A7FAAA", "#FFB0FF"];
	$ = (x) => { return document.getElementById(x) };

	// this creates the config string and file link
	function submit_data() {
		// read the form
		let the_form = $("the_form");

		var entries = [];
		var non_empty_groups = new Map();

		// list the properties of every valid element of the form
		Array.from(the_form.elements).forEach((element)=>{
			// var type = element.tagName;
			// var name = element.name;
			// var value = element.value;
			let group = element.getAttribute("group");

			if( element.tagName == "INPUT" ) {
				// filter the value to be a valid python string
				let value = element.value.replaceAll(/(\\|")/g, '\\$1');
				// add that to the valid entries
				entries.push({
					name: element.name,
					value: value,
					group: group
				});
				// compute empty groups for filtering
				if(group && value != "") {
					non_empty_groups.set(group, true);
				}
			}
		});

		// create the output string
		var output = "secrets = {\n";
		entries.forEach((entry, index) => {
			name = entry.name;
			value = entry.value;
			group = entry.group;

			// skip optional entries with no value
			if( group == "?" && value == "" ) return;
			// skip groups with no value
			if( group && !non_empty_groups.has(group) ) return;
			
			// python dict entry
			output += `  "${name}": "${value}",\n`;
		});
		output += "}\n";

		// output the string to the output text area
		let lines_num = output.split("\n").length + 1;
		let area = $("area");
		area.value = output;
		// resize and show the text area
		area.style.width = "400px";
		area.style.minHeight = `${lines_num}em`;
		$("output_text").style.display = "block";

		// prepare the data to generate the link
		let blob_data = new Blob([output], { type: "text/plain" });
		let blob_url = window.URL.createObjectURL(blob_data);
		// put the data into the link, with link text and file name
		var download = $("download_link");
		download.download = "secrets.py";
		download.title = "secrets.py";
		download.href = blob_url;
		download.innerHTML = "Download secrets.py";
		// show the link
		$("download").style.display = "block";
	}

	// dynamically generate the entry form from the field
	function make_form_auto() {
		let fields_list = fields_generator.split(/\s*\n\s*/);
		let the_form = $("the_form");
		var group_colors = new Map();
		var color_index = 0;

		fields_list.forEach((item, index) => {
			items = item.trim().split(":").concat(["", "", ""]);

			let name = items[0].trim();
			if(name == "") return;
			let value = items[1].trim();
			let group = items[2].trim();

			color = "";
			if( group && group != "?" ) {
				if( !group_colors.has(group) ) {
					group_colors.set(group, colors[color_index]);
					color_index = (color_index + 1) % colors.length;
				}
				color = group_colors.get(group);
			}

			let input = document.createElement("input");
			input.id = name;
			input.name = name;
			input.type = "text";
			input.placeholder = value;
			input.setAttribute("group", group);

			let label = document.createElement("label");
			label.for = name;
			label.innerHTML = (group ? "" : STAR) + `${name}`;

			let line = document.createElement("p");
			if(color) line.style.background = color;
			line.append(label);
			line.append(input);
			the_form.append(line);
		});
		let generate_config = $("generate_config");
		the_form.append(generate_config);
	}
	</script>
</head>
<body>
<p>Hello, this is a generic script to create a secrets.py file.</p>
<!--
This is the form itself.
It's created dynamically, displayed as a table, with a big button at the bottom.
-->
<form action="#" id="the_form" onsubmit="submit_data(); return false;">
	<p id="generate_config">
		<it>&nbsp;</it>
		<it><button onclick="submit_data();">Generate config</button></it>
	</p>
</form>
<!-- The download link pointing to the data blob of the file. -->
<p id="download"><a id="download_link" href="">Download link</a></p>
<!-- The output text field. Selects the whole text on focus for copy and paste. -->
<p id="output_text"><textarea id="area" onfocus="this.select()"></textarea></p>

<script>make_form_auto();</script>
</body>
</html>
